---
tags: [Book/Unit Testing]
title: 단위 테스트 구조
created: '2022-03-17T02:52:14.909Z'
modified: '2022-03-17T04:59:07.504Z'
---

# 단위 테스트 구조

## 단위 테스트를 구성하는 방법

### AAA 패턴

AAA 패턴은 Arrange, Act, Assert 세 부분으로 나눌 수 있다. 이 패턴은 모든 테스트가 균일한 구조를 갖도록 한다. 
- Arrange: 준비 구절에서는 테스트 대상 시스템과 의존성을 원하는 상태로 만든다.
- Act: 실행 구절에서는 테스트 대상 메서드를 호출하고 준비된 의존성을 전달하며 출력 값을 캡쳐한다.
- Assert: 검증 구절에서는 결과를 검증해 반환 값이나 최종 상태 등을 표시할 수 있다.

> given-when-then 패턴도 AAA 패턴과 같은 구조이나, 비개발자와 함께하는 테스트에 더 적합하다.

일반적으로 테스트는 준비 구절로 시작하지만 테스트 주도 개발(TDD)을 실천할 때는 검증 구절로 시작할 수 있다. 이 방법을 사용하면 특정 메서드가 무엇을 수행해야 하는지 목표를 생각할 수 있다.

### 여러 개의 준비, 실행, 검증 구절 피하기

만약 준비 -> 실행 -> 검증 -> 또다른 실행 -> 또다른 검증 순으로 테스트가 이뤄진다면 그 테스트는 여러 개의 동작 단위를 검증하고 있는 것이다. 이러한 테스트는 2장에 따라 단위 테스트가 아닌, 통합 테스트이다. 이렇게 다단계 테스트가 이뤄진다면 단위 테스트를 여러 개의 테스트로 나누는 것이 더 좋다.

### 테스트 내 if문 피하기

테스트 내에 if문이 있다는 것은 한 테스트 내에서 여러 분기를 테스트하고 있다는 의미이다. 테스트에 분기가 있어서 얻는 이점은 없으며 코드를 이해하기 어렵게 만드므로 별개의 테스트로 분리하는 것이 좋다.

### 각 구절은 얼마나 커야 하는가?

> 실제로 모디모아 테스트 코드를 리뷰해야 할 때 이 부분이 가장 고민되었다... 준비 단계에서 중복된 코드를 처리하는 방법을 알아보자!

- 준비 구절: 일반적으로 가장 길다. 실행과 검증을 합친 것만큼 클 수 있다. 그러나 이보다 훨씬 커진다면 같은 클래스 내 private 메서드 혹은 별도 팩토리 클래스로 추출하는 것이 좋다. 
- 실행 구절: 한 줄로만 이뤄지지 않았다면 캡슐화가 깨지지 않았는지 의심할 수 있다. 단일 작업을 테스트할 때 두 개 메서드 호출이 이뤄지는 것은 해당 클래스 API에 invariant violation 문제가 있다는 의미이다.

### 검증 구절에는 검증문이 얼마나 있어야 하는가

한 단위테스트는 여러 결과를 낼 수 있고, 하나의 테스트로 모든 코드를 평가하는 것이 좋다.
그러나 검증 구절이 과하게 커지는 것은 경계해야 한다.

### 가독성 높이기

의존성이 많은 경우, SUT(System Under Test)와 의존성을 구분하기 어려울 수 있다. 이런 경우에는 테스트 내 SUT 변수명을 sut로 할 수 있다. 또한 AAA 패턴에 대한 주석을 제거하고 빈 줄로 분리하는 것이 좋다.

## 테스트 간 테스트 픽스처 재사용

> 테스트 픽스처는 테스트 실행 대상 객체이다. 즉, SUT로 전달되는 인수이다. 이러한 객체는 각 테스트 실행 전에 고정 상태로 유지되므로 동일한 결과를 생성하는 것으로 기대된다. 

### 단순 추출

테스트에서 언제 어떻게 코드를 재사용할지 아는 것이 주요하다. 준비 구절은 라인 수가 많으므로 여기에서 코드를 재사용할 수 있다. 그러나 단순 메서드 추출은 아래와 같은 부작용이 있다.

1. 테스트 간 높은 결합도

그러나 테스트 준비 구절을 공통 메서드로 추출하면 한 테스트 로직을 수정하고 싶을 때 모든 테스트에 영향을 미쳐 쓸데없이 테스트가 실패할 수 있다. 2장에서 언급한 "모든 테스트는 서로 격리되어 실행되어야 한다"는 원칙을 어기게 된다. 이 원칙을 어기지 않으려면 테스트 클래스에 서로 다른 메서드가 공유하는 상태를 두지 않아야 한다.

2. 낮은 테스트 가독성

준비 구절을 메서드로 추출하면 테스트 가독성이 떨어진다. 한 테스트를 이해하기 위해 클래스의 다른 부분도 읽어야 하기 때문이다.

### 비공개 팩토리 메서드 사용

테스트 클래스에 비공개 팩토리 메서드를 두면 공통되는 초기화 코드를 팩터리 메서드를 호출함으로써 줄일 수 있고, 테스트 진행 상황에 대한 맥락을 유지할 수 있다.

데이터베이스 연결처럼 대부분의 테스트 메서드에서 사용되는 것은 인스턴스화하는 것이 낫다.

## 단위 테스트 명명법

변수명을 짓는 것이 개발자에게 가장 어려운 일인 것처럼 테스트에 이름을 붙이는 것도 공들일 필요가 있다. 테스트 이름은 관련 지식이 충분하지 않은 사람도 읽기 쉬울 만큼 가독성이 높아야 한다. 

읽기 쉬운 단위 테스트 명명 지침
- 엄격한 명명 정책을 따르지 않아야 한다.
- 어느 정도 표현의 자유를 보장해야 한다.
- 프로그램과 관련된 도메인에 익숙한 비개발자에게 시나리오를 설명한다고 생각하고 명명한다.
- 단어를 밑줄 표시로 구분한다.
- (개인 의견이지만) 협업하는 사람 중 외국인이 없다면 한글로 작성해도 충분하다.

## 매개변수화된 테스트 리팩터링하기

자바를 사용하는 경우, `@ParameterizedTest`를 사용해 한 테스트 메서드로 여러 상황을 테스트할 수 있다. 예를 들어, 날짜만 바뀐 주문 시나리오를 검증해야 한다면 날짜를 매개변수화할 수 있다.

## 검증문 라이브러리를 사용한 테스트 가독성 향상

자바를 사용하는 경우, assertJ등을 사용해 가독성을 높일 수 있다.

