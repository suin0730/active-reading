---
tags: [Book/Unit Testing]
title: 가치 있는 단위 테스트를 위한 리팩터링
created: '2022-05-05T04:16:03.012Z'
modified: '2022-05-05T05:37:20.221Z'
---

# 7. 가치 있는 단위 테스트를 위한 리팩터링

## 리팩터링할 코드 식별하기

리팩터링할 코드를 식별하기 위한 기준이 두 가지 있다.

- 코드 복잡도 및 도메인 유의성: 코드 복잡도는 코드 내 분기 지점 수로 정의된다. 도메인 유의성은 코드가 프로젝트 도메인에 얼마나 의미있는지를 나타낸다.
- 협력자 수: 협력자는 가변 의존성이거나 프로세스 외부 의존성이다. 협력자는 예상되는 조건으로 두어야 하기 때문에 협력자가 많은 코드는 테스트 비용이 많이 든다. 따라서 협력자가 많을수록 테스트는 커진다.

리팩터링할 코드 유형 
- (복잡도o,협력자x) 도메인 모델 혹은 알고리즘: 중요하거나 복잡한 로직을 테스트하므로 가치 있는 테스트이다. 협력자 수가 적어서 테스트 유지비도 낮다.
- (복잡도x,협력자x) 간단한 코드: 테스트할 필요가 거의 없다. 매개변수가 없는 생성자 등
- (복잡도x,협력자o) 컨트롤러: 비즈니스에 중요한 작업을 하는 것이 아니라, 도메인 클래스와 외부 어플리케이션 간 구성 요소의 작업을 조정한다. 따라서 테스트를 한다고 해도 간단하게 하면 된다.
- (복잡도o,협력자x) 지나치게 복잡한 코드: 예를 들어 복잡한 작업을 어디에도 위임하지 않고 모든 것을 스스로 하는 컨트롤러가 있다. 이런 경우는 단위 테스트를 작성하기 어렵지만 테스트 없이 두기에는 위험하다. 따라서 알고리즘과 컨트롤러로 분해하는 것이 좋다.

> 좋지 않은 테스트를 작성하는 것보다는 테스트를 전혀 작성하지 않는 편이 낫다.

## 험블 객체 패턴

일부 코드는 프레임워크 의존성과 결합되어 있기 때문에 테스트가 어려워진다. 예를 들어 비동기, 멀티스레드, 사용자 인터페이스 등과 함께 테스트하려면 테스트가 가능한 부분을 추출해서 험블 래퍼(humble wrapper)로 만들어야 한다. 책 내용 앞쪽에 나왔던 육각형 아키텍처와 함수형 아키텍처도 이 경우에 해당한다.

험블 객체 패턴을 사용하면 객체지향 5대 원칙 중 SRP도 지킬 수 있다. 예를 들어 비즈니스 로직과 오케스트레이션을 분리하면 두 가지 각각이 가져야 할 책임에 대해서 알아볼 수 있다. MVC, MVP 모델도 비즈니스 로직과 UI, 모델과 뷰 사이를 조정한다는 점에서 험블 객체 패턴이라 볼 수 있다.

비즈니스 로직과 오케스트레이션을 분리하면 테스트하기에 용이해지기도 하지만, 코드 복잡도를 해결할 수 있고 유지 보수 측면에서 장기적으로 프로젝트 성장에도 중요한 역할을 한다.

## 가치 있는 단위 테스트를 위한 리팩터링

1단계: 암시적 의존성을 명시적으로 만들기
테스트 용이성을 개선하려면 암시적 의존성을 명시적으로 만들 수 있다. 의존성에 대한 인터페이스를 주입해서 목으로 처리할 수 있지만, 테스트 취약성을 야기할 수 있기 때문에 프로세스 외부 협력자에게 의존하지 않는 것이 훨씬 더 깔끔하다.

2단계: 애플리케이션 서비스 계층 도입
도메인 모델이 외부 시스템과 직접 통신하는 문제를 극복하려면 험블 컨트롤러(서비스 레이어)로 책임을 옮길 수 있다. 서비스 계층을 작성할 때 주의할 점이 몇가지 있다.
- 프로세스 외부 의존성을 주입해야 한다. 인스턴스화할 시 통합 테스트에서 문제가 될 것이다.
- 컨트롤러는 원시 데이터를 엔티티 인스턴스로 재구성하면 안된다. 어플리케이션 서비스는 도메인에 관한 로직을 담당하지 말고, 오케스트레이션만 담당해야 한다.

3단계: 애플리케이션 서비스 복잡도 낮추기
ORM을 사용해 데이터베이스를 도메인 모델에 매핑하거나 도메인 모델에 원시 데이터베이스 데이터로 도메인 클래스를 인스턴스화하는 팩토리 클래스를 작성해야 한다. 도메인이 별도로 분리되어 있으면 모든 협력자와 완전히 분리되어 있으므로 테스트가 쉬워진다.

